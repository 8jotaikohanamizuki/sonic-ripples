<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Hachijotaiko Hanamizuki: Voice Waves</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    background: transparent;
    overflow: hidden;
}
canvas {
    display: block;
    background: transparent;
}
#startBtn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 240, 255, 0.15);
    border: 1px solid rgba(0, 240, 255, 0.5);
    color: rgba(0, 240, 255, 0.9);
    font-family: monospace;
    font-size: 1rem;
    padding: 12px 28px;
    cursor: pointer;
    border-radius: 4px;
    letter-spacing: 0.1em;
}
#startBtn:hover {
    background: rgba(0, 240, 255, 0.25);
}
#status {
    position: absolute;
    bottom: 10px;
    left: 10px;
    color: rgba(0, 240, 255, 0.4);
    font-family: monospace;
    font-size: 0.7rem;
    z-index: 100;
    display: none;
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<button id="startBtn">ğŸ¤ ãƒã‚¤ã‚¯ã§èµ·å‹•</button>
<div id="status"></div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const statusEl = document.getElementById('status');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let ripples = [];
let analyser, dataArray;

// â”€â”€ æ³¢ç´‹ç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function maybeAddRipple(volume) {
    if (volume > 45) {
        let power = (volume - 45) / (255 - 45);
        ripples.push({
            x: canvas.width / 2,
            y: canvas.height / 2,
            r: 5,
            opacity: 1,
            lineWidth: 2 + (power * 12),
            speed: 2 + (power * 12),
            color: `120, ${Math.floor(180 + power * 75)}, 255`
        });
    }
}

// â”€â”€ éŸ³å£°å‡¦ç†ãƒ«ãƒ¼ãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastRippleTime = 0;
function audioLoop() {
    requestAnimationFrame(audioLoop);
    analyser.getByteTimeDomainData(dataArray);
    // ç¬é–“ãƒ”ãƒ¼ã‚¯æ¤œå‡ºï¼ˆå¹³å‡ã‚ˆã‚Šé€Ÿã„ï¼‰
    let peak = 0;
    for (let i = 0; i < dataArray.length; i++) {
        const v = Math.abs(dataArray[i] - 128);
        if (v > peak) peak = v;
    }
    const volume = peak * 2;
    const now = performance.now();
    if (now - lastRippleTime > 30) { // 30msä»¥ä¸Šé–“éš”ã‚’ã‚ã‘ã‚‹
        maybeAddRipple(volume);
        if (volume > 45) lastRippleTime = now;
    }
}

// â”€â”€ æç”»ãƒ«ãƒ¼ãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function draw() {
    requestAnimationFrame(draw);
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for (let i = ripples.length - 1; i >= 0; i--) {
        const ripple = ripples[i];
        ctx.beginPath();
        ctx.arc(ripple.x, ripple.y, ripple.r, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(${ripple.color}, ${ripple.opacity})`;
        ctx.lineWidth = ripple.lineWidth;
        ctx.stroke();

        ripple.r += ripple.speed;
        ripple.opacity -= 0.02;

        if (ripple.opacity <= 0) ripples.splice(i, 1);
    }
}

// â”€â”€ ãƒã‚¤ã‚¯èµ·å‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
startBtn.addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        const audioCtx = new AudioContext();
        const source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 64;
        dataArray = new Uint8Array(analyser.fftSize);
        source.connect(analyser);

        startBtn.style.display = 'none';
        statusEl.style.display = 'block';
        statusEl.textContent = 'ğŸ¤ ãƒã‚¤ã‚¯æ¥ç¶šæ¸ˆã¿';
        setTimeout(() => statusEl.style.display = 'none', 3000);

        audioLoop();
    } catch (e) {
        statusEl.style.display = 'block';
        statusEl.textContent = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ' + e.message;
    }
});

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

draw();
</script>

</body>
</html>
