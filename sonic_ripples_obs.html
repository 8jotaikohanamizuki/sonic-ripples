<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TAKESHIBA: Voice Waves</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    background: transparent;
    overflow: hidden;
}
canvas {
    display: block;
    background: transparent;
}
#overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 100;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
}
button {
    padding: 15px 30px;
    font-size: 1rem;
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #00f0ff;
    color: #00f0ff;
    cursor: pointer;
    backdrop-filter: blur(5px);
    white-space: nowrap;
}
button:hover {
    background: rgba(0, 240, 255, 0.15);
}
#status {
    color: #888;
    font-size: 0.75rem;
    font-family: monospace;
    margin-top: 8px;
}
</style>
</head>
<body>

<div id="overlay">
    <button id="startMic">ğŸ¤ ãƒã‚¤ã‚¯ã§èµ·å‹•</button>
    <button id="startSystem">ğŸ”Š ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ã§èµ·å‹•ï¼ˆOBSæ¨å¥¨ï¼‰</button>
    <div id="status">éŸ³å£°ã‚½ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const statusEl = document.getElementById('status');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let audioContext, analyser, dataArray;
let ripples = [];
let started = false;

// â”€â”€ OBSãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹è‡ªå‹•èµ·å‹•ãƒã‚§ãƒƒã‚¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// OBSã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹ã¯ window.obsstudio ãŒå­˜åœ¨ã™ã‚‹
// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?autostart=1 ã§ãƒœã‚¿ãƒ³ãªã—ã§è‡ªå‹•èµ·å‹•ã§ãã‚‹
function checkAutoStart() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('autostart') === '1') {
        // OBSç’°å¢ƒã§ã¯ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£è©¦è¡Œ
        startAudio('system');
    }
}

// â”€â”€ ãƒã‚¤ã‚¯å…¥åŠ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('startMic').addEventListener('click', () => startAudio('mic'));

// â”€â”€ ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ï¼ˆç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£çµŒç”±ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('startSystem').addEventListener('click', () => startAudio('system'));

async function startAudio(mode) {
    try {
        statusEl.textContent = 'æ¥ç¶šä¸­...';
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;

        let stream;

        if (mode === 'mic') {
            // é€šå¸¸ãƒã‚¤ã‚¯
            stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

        } else {
            // ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°: getDisplayMedia ã§ç”»é¢å…±æœ‰ã®éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ã‚’å–å¾—
            // OBS Virtual Camera / ä»®æƒ³ãƒã‚¤ã‚¯çµŒç”±ã§ã‚‚å‹•ä½œã™ã‚‹
            try {
                stream = await navigator.mediaDevices.getDisplayMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        sampleRate: 44100
                    },
                    video: true  // æ˜ åƒã‚‚è¦æ±‚ã—ãªã„ã¨getDisplayMediaãŒå‹•ã‹ãªã„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ
                });
                // æ˜ åƒãƒˆãƒ©ãƒƒã‚¯ã¯ä¸è¦ãªã®ã§åœæ­¢
                stream.getVideoTracks().forEach(t => t.stop());

            } catch (displayErr) {
                // getDisplayMedia ãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒã‚¤ã‚¯ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                statusEl.textContent = 'ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°å¤±æ•— â†’ ãƒã‚¤ã‚¯ã§å†è©¦è¡Œä¸­...';
                stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            }
        }

        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        dataArray = new Uint8Array(analyser.frequencyBinCount);

        overlay.style.display = 'none';
        started = true;
        draw();

    } catch (err) {
        statusEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.message;
        console.error(err);
    }
}

// â”€â”€ OBS WebAudioç›´æ¥æ³¨å…¥ï¼ˆOBSãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹ã®å ´åˆï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// OBSã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹ã¯ãƒšãƒ¼ã‚¸ã«AudioContextã‚’è‡ªå‹•æ³¨å…¥ã—ãªã„ã€‚
// ã—ã‹ã—ã‚«ã‚¹ã‚¿ãƒ CSSã‚„URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ volume ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã‚‹ã€‚
// ä»¥ä¸‹ã¯ postMessage / BroadcastChannel çµŒç”±ã§å¤–éƒ¨ã‹ã‚‰éŸ³é‡ã‚’å—ã‘å–ã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
const bc = new BroadcastChannel('obs_audio');
bc.onmessage = (e) => {
    if (e.data && typeof e.data.volume === 'number' && !started) {
        // å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰éŸ³é‡ã‚’å—ã‘å–ã£ã¦æ³¢ç´‹ç”Ÿæˆ
        injectVolume(e.data.volume);
    }
};

function injectVolume(volume) {
    if (!started) {
        if (!ripples) ripples = [];
        maybeAddRipple(volume);
        if (!animating) {
            animating = true;
            drawExternal();
        }
    }
}

let animating = false;
function drawExternal() {
    if (!started) {
        requestAnimationFrame(drawExternal);
        renderRipples();
    }
}

// â”€â”€ ãƒ¡ã‚¤ãƒ³æç”»ãƒ«ãƒ¼ãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function draw() {
    requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArray);

    // å£°å¸¯åŸŸï¼ˆä¸­éŸ³åŸŸï¼‰ã‚’æŠ½å‡º
    let sum = 0;
    for (let i = 10; i < 80; i++) sum += dataArray[i];
    let volume = sum / 70;

    maybeAddRipple(volume);
    renderRipples();
}

function maybeAddRipple(volume) {
    if (volume > 45) {
        let power = (volume - 45) / (255 - 45);
        ripples.push({
            x: canvas.width / 2,
            y: canvas.height / 2,
            r: 5,
            opacity: 1,
            lineWidth: 2 + (power * 12),
            speed: 2 + (power * 12),
            color: `120, ${Math.floor(180 + power * 75)}, 255`
        });
    }
}

function renderRipples() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = ripples.length - 1; i >= 0; i--) {
        const ripple = ripples[i];
        ctx.beginPath();
        ctx.arc(ripple.x, ripple.y, ripple.r, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(${ripple.color}, ${ripple.opacity})`;
        ctx.lineWidth = ripple.lineWidth;
        ctx.stroke();

        ripple.r += ripple.speed;
        ripple.opacity -= 0.02;

        if (ripple.opacity <= 0) ripples.splice(i, 1);
    }
}

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«è‡ªå‹•èµ·å‹•ãƒã‚§ãƒƒã‚¯
window.addEventListener('load', checkAutoStart);
</script>

</body>
</html>
